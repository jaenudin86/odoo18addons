<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Stock Picking Form View - Add Generate SN Buttons -->
    <record id="view_picking_form_generate_sn_buttons" model="ir.ui.view">
        <field name="name">stock.picking.form.generate.sn.buttons</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            
            <!-- Add Generate SN buttons -->
            <xpath expr="//button[@name='action_assign']" position="after">
                
                <!-- Generate Serial Numbers Button -->
<button name="action_generate_serial_numbers" 
        string="Generate SN" 
        type="object" 
        class="btn-primary"
        invisible="state not in ['confirmed', 'assigned', 'waiting'] or not has_sn_products"
        help="Generate serial numbers (transfer must be confirmed first)"/>
                
                <!-- Quick Generate All Button -->
                <button name="action_bulk_generate_all" 
                        string="Quick Generate All" 
                        type="object" 
                        class="btn-success"
                        invisible="state not in ['confirmed', 'assigned', 'waiting'] or not has_sn_products or serial_numbers_generated"
                        confirm="This will automatically generate serial numbers for all products. Continue?"
                        help="Auto-generate all SNs"/>
        <button name="action_print_sn_qrcode" 
            string="Print SN QR" 
            type="object" 
            class="btn-info"
            icon="fa-print"
            invisible="not serial_numbers_generated or state not in ['confirmed', 'assigned', 'waiting']"
            help="Print QR code labels for generated serial numbers"/>
            </xpath>
            
            <!-- Add stat buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <!-- Generated SNs Button -->
                <button name="action_view_generated_sns" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-barcode"
                        invisible="generated_sn_count == 0">
                    <field name="generated_sn_count" widget="statinfo" string="Generated SNs"/>
                </button>
                
                <!-- Scanned SNs Button -->
                <button name="action_view_sn_moves" 
                        type="object" 
                        class="oe_stat_button" 
                        icon="fa-check-square-o"
                        invisible="scanned_sn_count == 0">
                    <field name="scanned_sn_count" widget="statinfo" string="Scanned SNs"/>
                </button>
            </xpath>
            
            <!-- Add info banners -->
            <xpath expr="//sheet" position="before">
                <!-- Banner: Need to Generate SN -->
                <div class="alert alert-warning" role="alert" 
                     invisible="state not in ['confirmed', 'assigned', 'waiting'] or not has_sn_products or serial_numbers_generated">
                    <i class="fa fa-exclamation-triangle"/> 
                    <strong>Step 1:</strong> Generate serial numbers first.
                    <button name="action_generate_serial_numbers" 
                            string="Generate Now" 
                            type="object" 
                            class="btn btn-sm btn-primary ms-2"/>
                </div>
                
                <!-- Banner: SN Generated, Need to Scan -->
                <div class="alert alert-info" role="alert" 
                     invisible="not serial_numbers_generated or sn_scan_complete or state not in ['confirmed', 'assigned', 'waiting']">
                    <i class="fa fa-info-circle"/> 
                    <strong>Step 2:</strong> 
                    <field name="generated_sn_count" class="fw-bold"/> serial numbers generated. 
                    <field name="scanned_sn_count" class="fw-bold"/> scanned.
                    Please scan remaining <field name="sn_remaining" class="fw-bold text-danger"/> SNs.
                    <button name="action_scan_serial_number" 
                            string="Start Scanning" 
                            type="object" 
                            class="btn btn-sm btn-success ms-2"
                            invisible="not require_sn_scan"/>
                </div>
                
                <!-- Banner: All Scanned, Ready to Validate -->
                <div class="alert alert-success" role="alert" 
                     invisible="not sn_scan_complete or state not in ['confirmed', 'assigned', 'waiting']">
                    <i class="fa fa-check-circle"/> 
                    <strong>Step 3:</strong> 
                    All <field name="scanned_sn_count"/> serial numbers scanned! You can now validate the transfer.
                </div>
            </xpath>
            
            <!-- Add tracking fields -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="serial_numbers_generated" invisible="1"/>
                <field name="generated_sn_count" invisible="1"/>
                <field name="scanned_sn_count" invisible="1"/>
                <field name="sn_remaining" invisible="1"/>
                <field name="sn_scan_complete" invisible="1"/>
                <field name="has_sn_products" invisible="1"/>
                <field name="require_sn_scan" invisible="1"/>
            </xpath>
            
            <!-- Add SN Info in notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Serial Numbers" 
                      name="serial_numbers"
                      invisible="not has_sn_products">
                    
                    <group>
                        <group string="Generation Status">
                            <field name="serial_numbers_generated" readonly="1" widget="boolean"/>
                            <field name="generated_sn_count" readonly="1" string="SNs Generated"/>
                        </group>
                        <group string="Scan Status">
                            <field name="scanned_sn_count" readonly="1" string="SNs Scanned"/>
                            <field name="sn_remaining" readonly="1" string="Remaining"/>
                            <field name="sn_scan_complete" readonly="1" widget="boolean" string="Scan Complete"/>
                        </group>
                    </group>
                    
                    <separator string="Products Status"/>
                    <field name="move_ids_without_package" nolabel="1">
                        <list>
                            <field name="product_id"/>
                            <field name="product_uom_qty" string="Quantity"/>
                            <field name="sn_needed" string="SN Needed"/>
                            <field name="sn_generated" string="Generated"/>
                            <field name="sn_scanned" string="Scanned"/>
                            <field name="sn_status" string="Status"/>
                        </list>
                    </field>
                    
                    <!-- Generated SNs Section -->
                    <group string="Generated Serial Numbers" invisible="generated_sn_count == 0">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle"/> 
                            <field name="generated_sn_count" class="fw-bold"/> serial numbers have been generated and are ready for scanning.
                            <button name="action_view_generated_sns" 
                                    type="object" 
                                    string="View All" 
                                    class="btn btn-sm btn-link"/>
                        </div>
                    </group>
                    
                    <!-- Scanned SNs Section -->
                    <group string="Scanned Serial Numbers" invisible="scanned_sn_count == 0">
                        <field name="sn_move_ids" nolabel="1">
                            <list>
                                <field name="serial_number_name" string="Serial Number"/>
                                <field name="product_tmpl_id" string="Product"/>
                                <field name="scan_date" string="Scanned At"/>
                                <field name="user_id" string="Scanned By"/>
                            </list>
                        </field>
                    </group>
                    
                    <!-- Warning if not all scanned -->
                    <div class="alert alert-warning" 
                         invisible="sn_scan_complete or generated_sn_count == 0">
                        <i class="fa fa-exclamation-triangle"/> 
                        <strong>Warning:</strong> Not all serial numbers have been scanned yet.
                        <br/>
                        Generated: <field name="generated_sn_count"/> | 
                        Scanned: <field name="scanned_sn_count"/> | 
                        Remaining: <field name="sn_remaining" class="fw-bold text-danger"/>
                    </div>
                </page>
            </xpath>
            <xpath expr="//page[@name='operations']" position="attributes">
    <attribute name="invisible">0</attribute>
</xpath>

<xpath expr="//page[@name='operations']//field[@name='move_line_ids_without_package']" position="replace">
    <field name="move_line_ids_without_package" context="{'tree_view_ref': 'stock.view_stock_move_line_operation_tree', 'default_picking_id': id, 'default_location_id': location_id, 'default_location_dest_id': location_dest_id}">
        <tree editable="bottom" decoration-danger="quantity == 0" decoration-success="quantity > 0">
            <field name="product_id" readonly="1"/>
            <field name="lot_id" readonly="1"/>
            <field name="lot_name" string="Serial Number" readonly="1"/>
            <field name="location_id" invisible="1"/>
            <field name="location_dest_id" invisible="1"/>
            <field name="quantity" string="Done" sum="Total Done"/>
            <field name="reserved_uom_qty" invisible="1"/>
            <field name="product_uom_id" invisible="1"/>
        </tree>
    </field>
</xpath>
            
        </field>
    </record>
</odoo>